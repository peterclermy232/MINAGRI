<main id="main" class="main">
  <div class="pagetitle">
    <h1>Manage Farms</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a routerLink="/dashboard">Home</a></li>
        <li class="breadcrumb-item">Policy Administration</li>
        <li class="breadcrumb-item active">Manage Farms</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 mt-3" *ngIf="canCreate">
              <h5 class="card-title">Farm List</h5>
              <button type="button" class="btn btn-primary" (click)="openModal()">
                <i class="bi bi-plus-circle me-1"></i> Add New Farm
              </button>
            </div>

            <!-- Search Bar -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Search by farm name, location, or farmer..."
                    [(ngModel)]="searchTerm"
                  />
                </div>
              </div>
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="isLoading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>

            <!-- Farms Table -->
            <div *ngIf="!isLoading" class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Farm Name</th>
                    <th scope="col">Farmer</th>
                    <th scope="col">Size</th>
                    <th scope="col">Location</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let farm of filteredFarms; let i = index">
                    <th scope="row">{{ i + 1 }}</th>
                    <td>{{ farm.farm_name }}</td>
                    <td>{{ farm.farmer_name || getFarmerName(farm.farmer) }}</td>
                    <td>{{ farm.farm_size }} {{ farm.unit_of_measure }}</td>
                    <td>
                      {{ farm.location_province }}<span *ngIf="farm.location_district">, {{ farm.location_district }}</span>
                    </td>
                    <td>
                      <span
                        class="badge"
                        [ngClass]="{
                          'bg-success': farm.status === 'ACTIVE',
                          'bg-secondary': farm.status === 'INACTIVE'
                        }"
                      >
                        {{ farm.status }}
                      </span>
                    </td>
                    <td *ngIf="canUpdate || canDelete">
                      <button *ngIf="canUpdate"
                        type="button"
                        class="btn btn-sm btn-info me-1"
                        (click)="editFarm(farm)"
                        title="Edit"
                      >
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button *ngIf="canDelete"
                        type="button"
                        class="btn btn-sm btn-danger"
                        (click)="deleteFarm(farm.farm_id!)"
                        title="Delete"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="filteredFarms.length === 0">
                    <td colspan="7" class="text-center py-4">
                      <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                      <p class="mt-2 text-muted">No farms found</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ isEditMode ? 'Edit Farm' : 'Add New Farm' }}</h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="farmForm">
            <div class="row">
              <!-- Farmer Selection -->
              <div class="col-md-6 mb-3">
                <label for="farmer" class="form-label">Farmer <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="farmer"
                  formControlName="farmer"
                  [class.is-invalid]="farmForm.get('farmer')?.invalid && farmForm.get('farmer')?.touched"
                >
                  <option value="">Select Farmer</option>
                  <option *ngFor="let farmer of farmers" [value]="farmer.farmer_id">
                    {{ farmer.first_name }} {{ farmer.last_name }} ({{ farmer.id_number }})
                  </option>
                </select>
                <div class="invalid-feedback">Please select a farmer</div>
              </div>

              <!-- Farm Name -->
              <div class="col-md-6 mb-3">
                <label for="farm_name" class="form-label">Farm Name <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  id="farm_name"
                  formControlName="farm_name"
                  placeholder="Enter farm name"
                  [class.is-invalid]="farmForm.get('farm_name')?.invalid && farmForm.get('farm_name')?.touched"
                />
                <div class="invalid-feedback">Please enter a farm name</div>
              </div>

              <!-- Farm Size -->
              <div class="col-md-6 mb-3">
                <label for="farm_size" class="form-label">Farm Size <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="farm_size"
                  formControlName="farm_size"
                  placeholder="Enter size"
                  step="0.01"
                  [class.is-invalid]="farmForm.get('farm_size')?.invalid && farmForm.get('farm_size')?.touched"
                />
                <div class="invalid-feedback">Please enter a valid farm size</div>
              </div>

              <!-- Unit of Measure -->
              <div class="col-md-6 mb-3">
                <label for="unit_of_measure" class="form-label">Unit of Measure <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="unit_of_measure"
                  formControlName="unit_of_measure"
                  [class.is-invalid]="farmForm.get('unit_of_measure')?.invalid && farmForm.get('unit_of_measure')?.touched"
                >
                  <option *ngFor="let unit of unitOptions" [value]="unit">{{ unit }}</option>
                </select>
                <div class="invalid-feedback">Please select a unit</div>
              </div>

              <!-- Province -->
              <div class="col-md-4 mb-3">
                <label for="location_province" class="form-label">Province</label>
                <input
                  type="text"
                  class="form-control"
                  id="location_province"
                  formControlName="location_province"
                  placeholder="Enter province"
                />
              </div>

              <!-- District -->
              <div class="col-md-4 mb-3">
                <label for="location_district" class="form-label">District</label>
                <input
                  type="text"
                  class="form-control"
                  id="location_district"
                  formControlName="location_district"
                  placeholder="Enter district"
                />
              </div>

              <!-- Sector -->
              <div class="col-md-4 mb-3">
                <label for="location_sector" class="form-label">Sector</label>
                <input
                  type="text"
                  class="form-control"
                  id="location_sector"
                  formControlName="location_sector"
                  placeholder="Enter sector"
                />
              </div>

              <!-- Status -->
              <div class="col-md-12 mb-3">
                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="status"
                  formControlName="status"
                  [class.is-invalid]="farmForm.get('status')?.invalid && farmForm.get('status')?.touched"
                >
                  <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                </select>
                <div class="invalid-feedback">Please select a status</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="saveFarm()">
            {{ isEditMode ? 'Update' : 'Save' }} Farm
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal"></div>
</main>
