<main id="main" class="main">
  <div class="pagetitle">
    <h1>Policy Quotation</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a routerLink="/">Home</a></li>
        <li class="breadcrumb-item">Dashboard</li>
        <li class="breadcrumb-item active">Policy Quotation</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <!-- Action Bar -->
    <nav class="navbar navbar-light" *ngIf="canCreate">
      <div class="container">
        <div class="flex-centered">
          <button class="btn btn-success" type="button" (click)="clickAddEmployee()"
            data-bs-toggle="modal" data-bs-target="#exampleModal">
            Open Quotation
          </button>
        </div>
      </div>
    </nav>

    <!-- Debug Info - Remove in production -->
    <div class="alert alert-info mt-2" *ngIf="farmers.length === 0 || insuranceProducts.length === 0">
      <strong>Debug Info:</strong>
      <ul class="mb-0">
        <li>Farmers loaded: {{ farmers.length }}</li>
        <li>Insurance Products loaded: {{ insuranceProducts.length }}</li>
        <li>All Farms loaded: {{ allFarms.length }}</li>
        <li>Quotations loaded: {{ quotationData.length }}</li>
      </ul>
      <small class="text-muted">If any value is 0, check your API endpoints and Django server.</small>
    </div>

    <!-- Search and Export -->
    <div class="d-flex justify-content-lg-between mt-2">
      <div class="search">
        <input
          class="form-control mt-2 mb-2 input-sm"
          type="text"
          placeholder="Search by policy number, status, or farmer name..."
          [(ngModel)]="searchText"
          (ngModelChange)="onSearchChange()"
        />
      </div>
      <button class="btn btn-success btn-lg" type="button">Export</button>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="text-center mt-3">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Quotations Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped table-hover mt-3 w-100">
        <thead>
          <tr>
            <th>Quotation ID</th>
            <th>Policy Number</th>
            <th>Farmer</th>
            <th>Farm</th>
            <th>Insurance Product</th>
            <th>Premium Amount</th>
            <th>Sum Insured</th>
            <th>Status</th>
            <th>Quotation Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="filteredQuotations.length === 0 && !isLoading">
            <td colspan="10" class="text-center">
              <div class="py-3">
                <p class="mb-1">No quotations found.</p>
                <small class="text-muted">Total quotations in database: {{ quotationData.length }}</small>
              </div>
            </td>
          </tr>

          <tr *ngFor="let row of filteredQuotations">
            <td>{{ row.quotation_id }}</td>
            <td>{{ row.policy_number || 'N/A' }}</td>
            <!-- Use helper functions to display names instead of IDs -->
            <td>{{ row.farmer_name || getFarmerName(row.farmer) }}</td>
            <td>{{ row.farm_name || getFarmName(row.farm) }}</td>
            <td>{{ row.product_name || getProductName(row.insurance_product) }}</td>
            <td>{{ row.premium_amount | currency:'KES ' }}</td>
            <td>{{ row.sum_insured | currency:'KES ' }}</td>
            <td>
              <span class="badge" [ngClass]="{
                'bg-warning': row.status === 'OPEN',
                'bg-success': row.status === 'PAID',
                'bg-primary': row.status === 'WRITTEN',
                'bg-secondary': row.status === 'CANCELLED'
              }">
                {{ row.status }}
              </span>
            </td>
            <td>{{ row.quotation_date | date:'short' }}</td>
            <td *ngIf="canUpdate || canDelete">
              <div class="btn-group" role="group">
                <button *ngIf="canUpdate"
                  class="btn btn-warning btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#exampleModal"
                  (click)="onEdit(row)"
                  title="Edit">
                  Edit
                </button>
                <button
                  *ngIf="row.status === 'OPEN'"
                  class="btn btn-success btn-sm"
                  (click)="markAsPaid(row.quotation_id)"
                  title="Mark as Paid">
                  Pay
                </button>
                <button
                  *ngIf="row.status === 'PAID'"
                  class="btn btn-primary btn-sm"
                  (click)="writePolicy(row.quotation_id)"
                  title="Write Policy">
                  Write
                </button>
                <button
                  *ngIf="canDelete"
                  class="btn btn-danger btn-sm"
                  (click)="deleteQuotation(row.quotation_id)"
                  title="Delete">
                  Delete
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>
        <button
          class="btn btn-secondary btn-sm"
          [disabled]="page === 1"
          (click)="prevPage()">
          Previous
        </button>
        <button
          class="btn btn-secondary btn-sm ms-2"
          [disabled]="page === totalPages"
          (click)="nextPage()">
          Next
        </button>
      </div>
      <div>Page {{ page }} of {{ totalPages }} ({{ filteredQuotations.length }} items)</div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
              {{ showAdd ? 'Create Policy Quotation' : 'Edit Policy Quotation' }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- Debug info in modal -->
            <div class="alert alert-warning" *ngIf="farmers.length === 0 || insuranceProducts.length === 0">
              <small>
                <strong>Warning:</strong> Some dropdown data is missing.
                <br>Farmers: {{ farmers.length }}, Products: {{ insuranceProducts.length }}
              </small>
            </div>

            <form [formGroup]="formValue">

              <!-- Farmer Selection -->
              <div class="mb-3">
                <label class="form-label">Select Farmer <span class="text-danger">*</span></label>
                <select
                  class="form-control"
                  formControlName="farmer"
                  (change)="onFarmerChange($event)"
                  [class.is-invalid]="formValue.get('farmer')?.invalid && formValue.get('farmer')?.touched">
                  <option value="">-- Select Farmer ({{ farmers.length }} available) --</option>
                  <option *ngFor="let farmer of farmers" [value]="farmer.farmer_id">
                    {{ farmer.first_name }} {{ farmer.last_name }} ({{ farmer.id_number }})
                  </option>
                </select>
                <div class="invalid-feedback">Farmer is required</div>
              </div>

              <!-- Farm Selection -->
              <div class="mb-3">
                <label class="form-label">Select Farm <span class="text-danger">*</span></label>
                <select
                  class="form-control"
                  formControlName="farm"
                  [class.is-invalid]="formValue.get('farm')?.invalid && formValue.get('farm')?.touched"
                  [disabled]="!formValue.get('farmer')?.value || allFarms.length === 0">
                  <option value="">
                    {{ formValue.get('farmer')?.value ? '-- Select Farm (' + allFarms.length + ' available) --' : '-- Select a farmer first --' }}
                  </option>
                  <option *ngFor="let farm of allFarms" [value]="farm.farm_id">
                    {{ farm.farm_name }} ({{ farm.farm_size }} {{ farm.unit_of_measure }})
                  </option>
                </select>
                <div class="invalid-feedback">Farm is required</div>
                <small class="text-muted" *ngIf="formValue.get('farmer')?.value && farms.length === 0">
                  Loading farms or no farms available for this farmer...
                </small>
              </div>

              <!-- Insurance Product Selection -->
              <div class="mb-3">
                <label class="form-label">Select Insurance Product <span class="text-danger">*</span></label>
                <select
                  class="form-control"
                  formControlName="insurance_product"
                  (change)="onProductChange($event)"
                  [class.is-invalid]="formValue.get('insurance_product')?.invalid && formValue.get('insurance_product')?.touched">
                  <option value="">-- Select Product ({{ insuranceProducts.length }} available) --</option>
                  <option *ngFor="let product of insuranceProducts" [value]="product.product_id">
                    {{ product.product_name }} (Rate: {{ product.average_premium_rate }}%)
                  </option>
                </select>
                <div class="invalid-feedback">Insurance Product is required</div>
              </div>

              <!-- Sum Insured -->
              <div class="mb-3">
                <label class="form-label">Sum Insured (KES) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  formControlName="sum_insured"
                  class="form-control"
                  placeholder="0.00"
                  min="0.01"
                  step="0.01"
                  [class.is-invalid]="formValue.get('sum_insured')?.invalid && formValue.get('sum_insured')?.touched">
                <div class="invalid-feedback">Sum Insured is required and must be greater than 0</div>
              </div>

              <!-- Premium Amount -->
              <div class="mb-3">
                <label class="form-label">Premium Amount (KES) <span class="text-danger">*</span></label>
                <input
                  type="number"
                  formControlName="premium_amount"
                  class="form-control"
                  placeholder="0.00"
                  min="0.01"
                  step="0.01"
                  [class.is-invalid]="formValue.get('premium_amount')?.invalid && formValue.get('premium_amount')?.touched">
                <div class="invalid-feedback">Premium Amount is required and must be greater than 0</div>
              </div>

              <!-- Status -->
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-control" formControlName="status">
                  <option value="OPEN">Open</option>
                  <option value="PAID">Paid</option>
                  <option value="WRITTEN">Written</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>
              </div>

            </form>
          </div>

          <div class="modal-footer">
            <button type="button" id="cancel" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button
              type="button"
              *ngIf="showAdd"
              (click)="postEmployeeDetails()"
              class="btn btn-primary"
              [disabled]="isLoading || formValue.invalid">
              <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
              Create Quotation
            </button>
            <button
              type="button"
              *ngIf="showUpdate"
              (click)="updateEmployeeDetails()"
              class="btn btn-primary"
              [disabled]="isLoading || formValue.invalid">
              <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
              Update Quotation
            </button>
          </div>
        </div>
      </div>
    </div>

  </section>
</main>
